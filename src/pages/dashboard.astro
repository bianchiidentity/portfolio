---
import Layout from "../layouts/Layout.astro";

// ç¨®ç›®ãƒªã‚¹ãƒˆï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰
const EXERCISE_LIST = [
  { id: 1, name: "ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹", displayOrder: 1, icon: "ğŸ’ª" },
  { id: 2, name: "ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ã‚¹", displayOrder: 2, icon: "ğŸ‹ï¸â€â™‚ï¸" },
  { id: 3, name: "ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤", displayOrder: 3, icon: "ğŸ¦‹" },
  { id: 4, name: "ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹", displayOrder: 4, icon: "ğŸ¤²" },
  { id: 5, name: "ãƒªã‚¢ãƒ‡ãƒ«ãƒˆ", displayOrder: 5, icon: "ğŸ¦…" },
  { id: 6, name: "ãƒãƒ³ãƒ‹ãƒ³ã‚°", displayOrder: 6, icon: "ğŸ§—" },
  { id: 7, name: "ãƒ©ãƒƒãƒˆãƒ—ãƒ«", displayOrder: 7, icon: "ğŸ¯" },
  { id: 8, name: "ã‚±ãƒ¼ãƒ–ãƒ«ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°", displayOrder: 8, icon: "ğŸš£" },
  { id: 9, name: "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", displayOrder: 9, icon: "ğŸ¦µ" },
  { id: 10, name: "ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹", displayOrder: 10, icon: "ğŸ¦¿" },
  { id: 11, name: "ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«", displayOrder: 11, icon: "ğŸ¦µ" },
  { id: 12, name: "ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³", displayOrder: 12, icon: "ğŸ¦µ" },
  { id: 13, name: "ã‚¢ãƒ€ã‚¯ã‚¿ãƒ¼", displayOrder: 13, icon: "ğŸ¦µ" },
  { id: 14, name: "ã‚¢ãƒ–ãƒ€ã‚¯ã‚¿ãƒ¼", displayOrder: 14, icon: "ğŸ¦µ" },
  { id: 15, name: "ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«", displayOrder: 15, icon: "ğŸ’ª" },
  { id: 16, name: "ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ", displayOrder: 16, icon: "ğŸ‹ï¸" },
].sort((a, b) => a.displayOrder - b.displayOrder);

// ç¨®ç›®åã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getExerciseIcon(exerciseName) {
  const exercise = EXERCISE_LIST.find((ex) => ex.name === exerciseName);
  return exercise?.icon || "ğŸ‹ï¸";
}

// ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const locals = Astro.locals;
const DB = locals?.runtime?.env?.DB;

let exerciseData = [];
let bookData = [];
let outputData = [];
let sleepData = [];

if (DB) {
  try {
    // ç­‹ãƒˆãƒ¬ãƒ‡ãƒ¼ã‚¿
    const exerciseResult = await DB.prepare(
      "SELECT * FROM exercise ORDER BY date DESC LIMIT 30"
    ).all();
    exerciseData = exerciseResult.results || [];

    // èª­æ›¸ãƒ‡ãƒ¼ã‚¿
    const bookResult = await DB.prepare(
      "SELECT * FROM book ORDER BY date DESC LIMIT 30"
    ).all();
    bookData = bookResult.results || [];

    // ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
    const outputResult = await DB.prepare(
      "SELECT * FROM output ORDER BY date DESC LIMIT 30"
    ).all();
    outputData = outputResult.results || [];

    // ç¡çœ ãƒ‡ãƒ¼ã‚¿
    const sleepResult = await DB.prepare(
      "SELECT * FROM sleep ORDER BY date DESC LIMIT 30"
    ).all();
    sleepData = sleepResult.results || [];
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
  }
}

// ç­‹ãƒˆãƒ¬çµ±è¨ˆã®è¨ˆç®—
const exerciseStats = {};
exerciseData.forEach((item) => {
  const name = item.exercise_name;
  if (!exerciseStats[name]) {
    exerciseStats[name] = {
      name,
      totalCount: 0,
      totalWeight: 0,
      sessions: 0,
    };
  }
  exerciseStats[name].totalCount += item.count || 0;
  exerciseStats[name].totalWeight += item.weight || 0;
  exerciseStats[name].sessions += 1;
});

const exerciseStatsArray = Object.values(exerciseStats).sort(
  (a, b) => (b as any).sessions - (a as any).sessions
);

// èª­æ›¸çµ±è¨ˆã®è¨ˆç®—
const bookStats = {};
bookData.forEach((item) => {
  const title = item.title;
  if (!bookStats[title]) {
    bookStats[title] = {
      title,
      totalPages: 0,
      sessions: 0,
    };
  }
  bookStats[title].totalPages += item.pages_read || 0;
  bookStats[title].sessions += 1;
});

const bookStatsArray = Object.values(bookStats).sort(
  (a, b) => b.sessions - a.sessions
);

// ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆçµ±è¨ˆã®è¨ˆç®—
const outputStats = {};
outputData.forEach((item) => {
  const type = item.type;
  if (!outputStats[type]) {
    outputStats[type] = {
      type,
      totalChars: 0,
      sessions: 0,
      techCount: 0,
    };
  }
  outputStats[type].totalChars += item.chars || 0;
  outputStats[type].sessions += 1;
  if (item.is_tech) {
    outputStats[type].techCount += 1;
  }
});

const outputStatsArray = Object.values(outputStats).sort(
  (a, b) => b.sessions - a.sessions
);

// ç¡çœ çµ±è¨ˆã®è¨ˆç®—
const sleepStats = {};
sleepData.forEach((item) => {
  const date = item.date;
  if (!sleepStats[date]) {
    sleepStats[date] = {
      date,
      hours: item.hours || 0,
    };
  }
});

const sleepStatsArray = Object.values(sleepStats).sort(
  (a, b) => new Date(b.date) - new Date(a.date)
);
---

<Layout>
  <main class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">ğŸ“Š ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="dashboard-subtitle">ã‚ãªãŸã®æ—¥ã€…ã®æ´»å‹•ã‚’å¯è¦–åŒ–</p>
    </div>

    <div class="dashboard-grid">
      <!-- ç­‹ãƒˆãƒ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="dashboard-section exercise-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ’ª ç­‹ãƒˆãƒ¬</h2>
          <a href="/input" class="add-btn">â• è¿½åŠ </a>
        </div>
        <div class="exercise-stats">
          {
            exerciseStatsArray.length > 0 ? (
              exerciseStatsArray.map((stat) => (
                <div class="exercise-card">
                  <div class="exercise-icon">{getExerciseIcon(stat.name)}</div>
                  <div class="exercise-info">
                    <h3 class="exercise-name">{stat.name}</h3>
                    <div class="exercise-details">
                      <span class="detail-item">
                        <span class="detail-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³:</span>
                        <span class="detail-value">{stat.sessions}å›</span>
                      </span>
                      <span class="detail-item">
                        <span class="detail-label">ç·å›æ•°:</span>
                        <span class="detail-value">{stat.totalCount}å›</span>
                      </span>
                      <span class="detail-item">
                        <span class="detail-label">ç·é‡é‡:</span>
                        <span class="detail-value">{stat.totalWeight}kg</span>
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <div class="empty-state">
                <p>ã¾ã ç­‹ãƒˆãƒ¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <a href="/input" class="empty-state-btn">
                  ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                </a>
              </div>
            )
          }
        </div>
      </section>

      <!-- èª­æ›¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="dashboard-section book-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ“š èª­æ›¸</h2>
          <a href="/input" class="add-btn">â• è¿½åŠ </a>
        </div>
        <div class="book-stats">
          {
            bookStatsArray.length > 0 ? (
              bookStatsArray.map((stat) => (
                <div class="book-card">
                  <div class="book-icon">ğŸ“–</div>
                  <div class="book-info">
                    <h3 class="book-title">{stat.title}</h3>
                    <div class="book-details">
                      <span class="detail-item">
                        <span class="detail-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³:</span>
                        <span class="detail-value">{stat.sessions}å›</span>
                      </span>
                      <span class="detail-item">
                        <span class="detail-label">ç·ãƒšãƒ¼ã‚¸:</span>
                        <span class="detail-value">
                          {stat.totalPages}ãƒšãƒ¼ã‚¸
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <div class="empty-state">
                <p>ã¾ã èª­æ›¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <a href="/input" class="empty-state-btn">
                  ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                </a>
              </div>
            )
          }
        </div>
      </section>

      <!-- ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="dashboard-section output-section">
        <div class="section-header">
          <h2 class="section-title">âœï¸ ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ</h2>
          <a href="/input" class="add-btn">â• è¿½åŠ </a>
        </div>
        <div class="output-stats">
          {
            outputStatsArray.length > 0 ? (
              outputStatsArray.map((stat) => (
                <div class="output-card">
                  <div class="output-icon">âœï¸</div>
                  <div class="output-info">
                    <h3 class="output-type">{stat.type}</h3>
                    <div class="output-details">
                      <span class="detail-item">
                        <span class="detail-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³:</span>
                        <span class="detail-value">{stat.sessions}å›</span>
                      </span>
                      <span class="detail-item">
                        <span class="detail-label">ç·æ–‡å­—æ•°:</span>
                        <span class="detail-value">{stat.totalChars}æ–‡å­—</span>
                      </span>
                      <span class="detail-item">
                        <span class="detail-label">æŠ€è¡“ç³»:</span>
                        <span class="detail-value">{stat.techCount}å›</span>
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <div class="empty-state">
                <p>ã¾ã ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <a href="/input" class="empty-state-btn">
                  ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                </a>
              </div>
            )
          }
        </div>
      </section>

      <!-- ç¡çœ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="dashboard-section sleep-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ˜´ ç¡çœ </h2>
          <a href="/input" class="add-btn">â• è¿½åŠ </a>
        </div>
        <div class="sleep-stats">
          {
            sleepStatsArray.length > 0 ? (
              sleepStatsArray.map((stat) => (
                <div class="sleep-card">
                  <div class="sleep-icon">ğŸ˜´</div>
                  <div class="sleep-info">
                    <h3 class="sleep-date">{stat.date}</h3>
                    <div class="sleep-details">
                      <span class="detail-item">
                        <span class="detail-label">ç¡çœ æ™‚é–“:</span>
                        <span class="detail-value">{stat.hours}æ™‚é–“</span>
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <div class="empty-state">
                <p>ã¾ã ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <a href="/input" class="empty-state-btn">
                  ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                </a>
              </div>
            )
          }
        </div>
      </section>
    </div>
  </main>
</Layout>

<style>
  .dashboard-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem 1rem;
    position: relative;
    overflow-x: hidden;
  }

  .dashboard-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    pointer-events: none;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 3rem;
    position: relative;
    z-index: 1;
  }

  .dashboard-title {
    font-size: 3rem;
    font-weight: 800;
    color: white;
    margin-bottom: 0.5rem;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.8s ease-out;
  }

  .dashboard-subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 300;
    margin: 0;
    animation: fadeInUp 0.8s ease-out 0.2s both;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .dashboard-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: fadeInUp 0.8s ease-out 0.4s both;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.1);
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #374151;
    margin: 0;
  }

  .add-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .exercise-stats,
  .book-stats,
  .output-stats,
  .sleep-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .exercise-card,
  .book-card,
  .output-card,
  .sleep-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: rgba(102, 126, 234, 0.05);
    border: 1px solid rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .exercise-card:hover,
  .book-card:hover,
  .output-card:hover,
  .sleep-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
  }

  .exercise-icon,
  .book-icon,
  .output-icon,
  .sleep-icon {
    font-size: 2rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    flex-shrink: 0;
  }

  .exercise-info,
  .book-info,
  .output-info,
  .sleep-info {
    flex: 1;
  }

  .exercise-name,
  .book-title,
  .output-type,
  .sleep-date {
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
    margin: 0 0 0.5rem 0;
  }

  .exercise-details,
  .book-details,
  .output-details,
  .sleep-details {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .detail-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }

  .detail-value {
    font-size: 0.9rem;
    color: #374151;
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
  }

  .empty-state p {
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  .empty-state-btn {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .empty-state-btn:hover {
    background: rgba(102, 126, 234, 0.2);
    transform: translateY(-1px);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .dashboard-title {
      font-size: 2.5rem;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .dashboard-section {
      padding: 1.5rem;
    }

    .exercise-details,
    .book-details,
    .output-details,
    .sleep-details {
      flex-direction: column;
      gap: 0.5rem;
    }
  }

  @media (max-width: 480px) {
    .dashboard-container {
      padding: 1rem 0.5rem;
    }

    .dashboard-title {
      font-size: 2rem;
    }

    .dashboard-section {
      padding: 1rem;
    }

    .exercise-card,
    .book-card,
    .output-card,
    .sleep-card {
      flex-direction: column;
      text-align: center;
    }

    .exercise-icon,
    .book-icon,
    .output-icon,
    .sleep-icon {
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
    }
  }
</style>
