---
import Layout from "../layouts/Layout.astro";
import ActivitySummary from "../components/dashboard/ActivitySummary.astro";
import ActivityCharts from "../components/dashboard/ActivityCharts.astro";
import Heatmap from "../components/dashboard/Heatmap.astro";
import ExerciseLog from "../components/dashboard/ExerciseLog.astro";
import BookLog from "../components/dashboard/BookLog.astro";
import OutputLog from "../components/dashboard/OutputLog.astro";

// åž‹å®šç¾©
interface ExerciseItem {
  exercise_name: string;
  count: number;
  weight: number;
  date: string;
}

interface BookItem {
  title: string;
  pages_read: number;
  date: string;
}

interface OutputItem {
  type: string;
  chars: number;
  is_tech: boolean;
  date: string;
}

interface ExerciseStats {
  [key: string]: {
    name: string;
    totalCount: number;
    totalWeight: number;
    sessions: number;
    lastDate: string | null;
  };
}

interface BookStats {
  [key: string]: {
    title: string;
    totalPages: number;
    sessions: number;
    lastDate: string | null;
  };
}

interface OutputStats {
  [key: string]: {
    type: string;
    totalChars: number;
    sessions: number;
    techCount: number;
    lastDate: string | null;
  };
}

// ç›´æŽ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const locals = Astro.locals;
const DB = (locals as any)?.runtime?.env?.DB;

let exerciseData = [];
let bookData = [];
let outputData = [];

if (DB) {
  try {
    // ç­‹ãƒˆãƒ¬ãƒ‡ãƒ¼ã‚¿
    const exerciseResult = await DB.prepare(
      "SELECT * FROM exercise ORDER BY date DESC LIMIT 50"
    ).all();
    exerciseData = exerciseResult.results || [];
    console.log("ç­‹ãƒˆãƒ¬ãƒ‡ãƒ¼ã‚¿:", exerciseData.length, "ä»¶");

    // èª­æ›¸ãƒ‡ãƒ¼ã‚¿
    const bookResult = await DB.prepare(
      "SELECT * FROM book ORDER BY date DESC LIMIT 50"
    ).all();
    bookData = bookResult.results || [];
    console.log("èª­æ›¸ãƒ‡ãƒ¼ã‚¿:", bookData.length, "ä»¶");

    // ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
    const outputResult = await DB.prepare(
      "SELECT * FROM output ORDER BY date DESC LIMIT 50"
    ).all();
    outputData = outputResult.results || [];
    console.log("ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿:", outputData.length, "ä»¶");
  } catch (error) {
    console.error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
  }
} else {
  console.log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼: DBãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
}

// ç­‹ãƒˆãƒ¬çµ±è¨ˆã®è¨ˆç®—
const exerciseStats: ExerciseStats = {};
const exerciseMaxRecords: { [key: string]: { maxWeight: number; maxCount: number } } = {};
exerciseData.forEach((item: ExerciseItem) => {
  const name = item.exercise_name;
  if (!exerciseStats[name]) {
    exerciseStats[name] = {
      name,
      totalCount: 0,
      totalWeight: 0,
      sessions: 0,
      lastDate: null,
    };
  }
  exerciseStats[name].totalCount += item.count || 0;
  exerciseStats[name].totalWeight += item.weight || 0;
  exerciseStats[name].sessions += 1;

  // æœ€å¤§è¨˜éŒ²ã®æ›´æ–°
  if (!exerciseMaxRecords[name]) {
    exerciseMaxRecords[name] = {
      maxWeight: 0,
      maxCount: 0,
    };
  }
  if ((item.weight || 0) > exerciseMaxRecords[name].maxWeight) {
    exerciseMaxRecords[name].maxWeight = item.weight || 0;
  }
  if ((item.count || 0) > exerciseMaxRecords[name].maxCount) {
    exerciseMaxRecords[name].maxCount = item.count || 0;
  }

  // æœ€æ–°æ—¥ä»˜ã®æ›´æ–°
  if (
    !exerciseStats[name].lastDate ||
    item.date > exerciseStats[name].lastDate
  ) {
    exerciseStats[name].lastDate = item.date;
  }
});

// èª­æ›¸çµ±è¨ˆã®è¨ˆç®—
const bookStats: BookStats = {};
bookData.forEach((item: BookItem) => {
  const title = item.title;
  if (!bookStats[title]) {
    bookStats[title] = {
      title,
      totalPages: 0,
      sessions: 0,
      lastDate: null,
    };
  }
  bookStats[title].totalPages += item.pages_read || 0;
  bookStats[title].sessions += 1;

  // æœ€æ–°æ—¥ä»˜ã®æ›´æ–°
  if (
    !bookStats[title].lastDate ||
    item.date > bookStats[title].lastDate
  ) {
    bookStats[title].lastDate = item.date;
  }
});

// ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆçµ±è¨ˆã®è¨ˆç®—
const outputStats: OutputStats = {};
outputData.forEach((item: OutputItem) => {
  const type = item.type;
  if (!outputStats[type]) {
    outputStats[type] = {
      type,
      totalChars: 0,
      sessions: 0,
      techCount: 0,
      lastDate: null,
    };
  }
  outputStats[type].totalChars += item.chars || 0;
  outputStats[type].sessions += 1;
  if (item.is_tech) {
    outputStats[type].techCount += 1;
  }

  // æœ€æ–°æ—¥ä»˜ã®æ›´æ–°
  if (
    !outputStats[type].lastDate ||
    item.date > outputStats[type].lastDate
  ) {
    outputStats[type].lastDate = item.date;
  }
});
---

<Layout>
  <main class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    </div>

    <div class="main-content">
      <ActivitySummary
        exerciseData={exerciseData}
        bookData={bookData}
        outputData={outputData}
        exerciseMaxRecords={exerciseMaxRecords}
        bookStats={bookStats}
        outputStats={outputStats}
      />

      <ActivityCharts exerciseData={exerciseData} bookData={bookData} />
    </div>

    <section class="calendar-section-main">
      <h2 class="calendar-title">ðŸ“… æ´»å‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <div class="calendar-card">
        <Heatmap
          exerciseData={exerciseData}
          bookData={bookData}
          outputData={outputData}
        />
      </div>
    </section>
    <section class="logs-section">
      <h2 class="logs-title">ðŸ“‹ è©³ç´°ãƒ­ã‚°</h2>
      <div class="logs-grid">
        <ExerciseLog exerciseData={exerciseData} />
        <BookLog bookData={bookData} />
        <OutputLog outputData={outputData} />
      </div>
    </section>
  </main>
</Layout>

<style>
  .dashboard-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
    position: relative;
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
  }

  .dashboard-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    pointer-events: none;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: 1;
    width: 100%;
    box-sizing: border-box;
  }

  .dashboard-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin-bottom: 0.25rem;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.8s ease-out;
  }

  .dashboard-subtitle {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 300;
    margin: 0;
    animation: fadeInUp 0.8s ease-out 0.2s both;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
  .main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    max-width: 1400px;
    width: 100%;
    margin: 0 auto 1rem auto;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out 0.3s both;
    min-height: 60vh;
  }

  /* ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .logs-section {
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out 0.4s both;
    margin-top: 1rem;
  }

  .logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .logs-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .add-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .logs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .dashboard-title {
      font-size: 2.5rem;
    }

    .logs-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .logs-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
  }

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .calendar-section-main {
    max-width: 1400px;
    margin: 0 auto 1rem auto;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out 0.4s both;
    width: 100%;
    box-sizing: border-box;
  }

  .calendar-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 1rem;
    text-align: center;
  }

  .calendar-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    overflow: hidden;
    width: 100%;
    min-width: 0;
    min-height: 200px;
    margin-right: 1rem;
  }

  @media (max-width: 480px) {
    .dashboard-container {
      padding: 1rem 0.5rem;
    }

    .dashboard-title {
      font-size: 2rem;
    }
  }
</style>
